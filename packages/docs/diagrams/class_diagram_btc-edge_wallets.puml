@startuml
enum CurrencyType {
    ETHEREUM
    BITCOIN
}
interface CreateWalletRequest extends InferType
class ContactAddress {
    +walletAddress: string
    +userId: number
    +user?: User
    +contacts?: Contact[]
}
class Contact {
    +contactName: string
    +userId: number
    +user?: User
    +addresses: ContactAddress[]
}
class ContactBuilder {
    -contactName: string
    -userId: number
    -addresses: string[]
    +setContactName(name: string): this
    +setUserId(userId: number): this
    +setAddresses(addresses: string[]): this
    +build(): Contact
}
enum CurrencyTypeUILabels {
    ETHEREUM
    BITCOIN
}
class Transaction {
    +id: number
    +transactionAddress: string
    +walletIn: string
    +walletOut: string
    +amount: string
    +gasPrice?: string
    +gasLimit?: string
    +createdAt: Date
    +tags: Tag[]
    +contactIn?: Contact
    +contactOut?: Contact
}
class TransactionBuilder {
    -id: number
    -address: string
    -walletIn: string
    -walletOut: string
    -contactIn: Contact
    -contactOut: Contact
    -amount: string
    -gasPrice: string
    -gasLimit: string
    -createdAt: Date
    -tags: Tag[]
    +setId(id: number): this
    +setAddress(address: string): this
    +setWalletIn(address: string): this
    +setWalletOut(address: string): this
    +setContactIn(contact: Contact): this
    +setContactOut(contact: Contact): this
    +setAmount(amount: number): this
    +setGasPrice(price: string): this
    +setGasLimit(limit: string): this
    +setCreatedAt(timestamp: string): this
    +setTags(tags: Tag[]): this
    +setTransaction(transaction: Transaction): this
    +build(): Transaction
}
class Tag {
    +tagName: string
    +userId: number
    +user: User
    +transactions: Transaction[]
}
enum Role {
    BASIC
    PRO
}
class Filter {
    +name: string
    +userId: number
    +user?: User
    +currencyType: CurrencyType
    +txnIn: boolean
    +txnOut: boolean
    +range: string
    +tagNames: string[]
    +contactNames: string[]
}
class FilterBuilder {
    -name: string
    -userId: number
    -currencyType: CurrencyType
    -txnIn: boolean
    -txnOut: boolean
    -range: string
    -tagNames: string[]
    -contactNames: string[]
    +setName(name: string): this
    +setUserId(userId: number): this
    +setCurrencyType(type: CurrencyType): this
    +setTxns(txnIn: boolean, txnOut: boolean): this
    +setRange(range: string): this
    +setTagNames(names: string[]): this
    +setContactNames(names: string[]): this
    +build(): Filter
}
class User {
    +id: number
    +firstName: string
    +lastName: string
    +email: string
    +password: string
    +areNotificationsEnabled: boolean
    +role: Role
    +createdAt: Date
    +wallets?: Wallet[]
    +tags?: Tag[]
    +contacts?: Contact[]
    +filters?: Filter[]
}
interface WalletWithBalance extends Wallet {
    +balance: string
}
class Wallet {
    +address: string
    +userId: number
    +name: string
    +user?: User
    +currencyType: CurrencyType
    +transactions: Transaction[]
}
class WalletBuilder {
    -address: string
    -userId: number
    -name: string
    -user: User
    -transactions: Transaction[]
    -balance: string
    +setAddress(address: string): this
    +setUserId(userId: number): this
    +setName(name: string): this
    +setUser(user: User): this
    +setTransactions(transactions: Transaction[]): this
    +setWallet(wallet: Wallet): this
    +setBalance(balance: string): this
    +build(): WalletWithBalance
}
interface UpdateWalletRequest extends InferType
abstract class AbstractGateway {
    -uri: string
    -fetch: any
    #request(method: Method, headers: Headers, path: string, body: any): Promise<T>
    #{abstract} handleError(response: any): Promise<void>
}
enum Method {
    POST
    GET
    PUT
    PATCH
    DELETE
}
class HttpError extends Error {
    +message: string
    +status: number
}
abstract class AbstractServiceGateway extends AbstractGateway {
    #handleError(response: any): Promise<void>
}
class BlockchainComGateway extends AbstractServiceGateway {
    -configService: ConfigService<Record<string, unknown>, false>
    -transactionsRepository: Repository<Transaction>
    +getBalance(walletAddress: string): Promise<string>
    +getTransactions(walletAddress: string): Promise<Transaction[]>
    +getTransactionsByTxAddress(txAddress: string): Promise<Transaction[]>
    -reversePoolMIMOTransaction(inputs: Out[], outputs: Out[]): PairsWithAmount
    -{static} DECIMALS: number
}
interface BalanceResponse {
    +final_balance: number
    +n_tx: number
    +total_received: number
}
interface TransactionsResponse {
    +address: string
    +n_tx: number
    +total_received: number
    +total_sent: number
    +final_balance: number
    +txs: Tx[]
}
interface TransactionResponse {
    +hash: string
    +ver: number
    +vin_sz: number
    +vout_sz: number
    +size: number
    +weight: number
    +fee: number
    +relayed_by: string
    +lock_time: number
    +tx_index: number
    +double_spend: boolean
    +time: number
    +block_index: number
    +block_height: number
    +inputs: Input[]
    +out: Out[]
}
interface Tx {
    +hash: string
    +ver: number
    +vin_sz: number
    +vout_sz: number
    +size: number
    +weight: number
    +fee: number
    +lock_time: number
    +tx_index: number
    +double_spend: boolean
    +time: number
    +block_index: number
    +block_height: number
    +inputs: Input[]
    +out: Out[]
    +result: number
    +balance: number
}
interface Input {
    +sequence: number
    +witness: string
    +script: string
    +index: number
    +prev_out: Out
}
interface Out {
    +addr: string
    +n: number
    +script: string
    +spending_outpoints: SpendingOutpoint[]
    +spent: boolean
    +tx_index: number
    +type: number
    +value: number
}
interface SpendingOutpoint {
    +n: number
    +tx_index: number
}
class TransactionsService {
    -transactionsRepository: Repository<Transaction>
    -blockchainComGateway: BlockchainComGateway
    -walletsService: WalletsService
    -walletsRepository: Repository<Wallet>
    +backfillTransactions(address: string): Promise<void>
    +findAll(userId: number): Promise<Transaction[]>
    +cleanup(address: string): Promise<Transaction[]>
}
abstract class AbstractNotificationStrategy {
    +{abstract} sendNotification(notification: Notification): Promise<void>
}
interface Notification {
    +to: string
    +title: string
    +body: string
    +attachment?: { filename: string; content: string; }
}
class EmailNotificationStrategy extends AbstractNotificationStrategy {
    -transporter: nodemailer.Transporter
    -from: string
    -configService: ConfigService<Record<string, unknown>, false>
    +sendNotification(notification: Notification): Promise<void>
}
class NotificationStrategyFactory {
    -emailNotificationStrategy: EmailNotificationStrategy
    +get(strategy: NotificationStrategy): AbstractNotificationStrategy
}
enum NotificationStrategy {
    EMAIL
    PUSH_NOTIFICATION
}
class TransactionNotificationService {
    -walletsRepository: Repository<Wallet>
    -notificationStrategyFactory: NotificationStrategyFactory
    +sendTransactionNotifications(transactions: Transaction[], currencyType: CurrencyType): Promise<void>
    -getBody(key: "walletOut" | "walletIn", wallet: Wallet, transaction: Transaction, currencyType: CurrencyType): string
    -getTitle(key: "walletOut" | "walletIn", currencyType: CurrencyType): string
    -{static} keys: readonly ["walletOut", "walletIn"]
}
class TransactionWatcherService {
    -ws: WebSocketClient
    -walletsRepository: Repository<Wallet>
    -transactionsRepository: Repository<Transaction>
    -blockchainComGateway: BlockchainComGateway
    -transactionNotificationService: TransactionNotificationService
    #open(): Promise<void>
    #message(data: WebSocketClient.Data): Promise<void>
    +subscribeAddress(address: string): Promise<void>
    +unsubscribeAddress(address: string): Promise<void>
}
interface WSMessage {
    +op: string
}
interface WSTransaction extends WSMessage {
    +x: { lock_time: number; ver: number; size: number; inputs: Input[]; time: number; tx_index: number; vin_sz: number; hash: string; vout_sz: number; relayed_by: string; out: Out[]; }
}
interface Input {
    +sequence: number
    +prev_out: { spent: boolean; tx_index: number; type: number; addr: string; value: number; n: number; script: string; }
    +script: string
}
interface Out {
    +spent: boolean
    +tx_index: number
    +type: number
    +addr: string
    +value: number
    +n: number
    +script: string
}
interface DeleteWalletRequest extends InferType
class WalletsService {
    -walletRepository: Repository<Wallet>
    -transactionsService: TransactionsService
    -blockchainComGateway: BlockchainComGateway
    -transactionWatcherService: TransactionWatcherService
    +create(req: CreateWalletRequest): Promise<WalletWithBalance>
    +findAll(userId: number): Promise<WalletWithBalance[]>
    +findOne(address: string, userId: number): Promise<Wallet>
    +delete(deleteWalletReq: DeleteWalletRequest): Promise<WalletWithBalance>
    +update(updateWalletReq: UpdateWalletRequest): Promise<WalletWithBalance>
}
interface GetWalletsRequest extends InferType
class WalletsController {
    -walletsService: WalletsService
    +create(body: CreateWalletRequest): Promise<WalletWithBalance>
    +findAll(params: GetWalletsRequest): Promise<WalletWithBalance[]>
    +delete(params: DeleteWalletRequest): Promise<WalletWithBalance>
    +update(body: UpdateWalletRequest): Promise<WalletWithBalance>
}
ContactAddress --> "1" User
ContactAddress --> "*" Contact
Contact --> "1" User
Contact --> "*" ContactAddress
ContactBuilder --> "1" Contact
Transaction --> "*" Tag
Transaction --> "1" Contact
TransactionBuilder --> "1" Contact
TransactionBuilder --> "*" Tag
TransactionBuilder --> "1" Tag
TransactionBuilder --> "1" Transaction
Tag --> "1" User
Tag --> "*" Transaction
Filter --> "1" User
Filter --> "1" CurrencyType
FilterBuilder --> "1" CurrencyType
FilterBuilder --> "1" Filter
User --> "1" Role
User --> "*" Wallet
User --> "*" Tag
User --> "*" Contact
User --> "*" Filter
Wallet --> "1" User
Wallet --> "1" CurrencyType
Wallet --> "*" Transaction
WalletBuilder --> "1" User
WalletBuilder --> "*" Transaction
WalletBuilder --> "1" Transaction
WalletBuilder --> "1" Wallet
WalletBuilder --> "1" WalletWithBalance
AbstractGateway --> "1" Method
BlockchainComGateway --> "1" Transaction
BlockchainComGateway --> "*" Transaction
BlockchainComGateway --> "1" Out
TransactionsResponse --> "*" Tx
TransactionResponse --> "*" Input
TransactionResponse --> "*" Out
Tx --> "*" Input
Tx --> "*" Out
Input --> "1" Out
Out --> "*" SpendingOutpoint
TransactionsService --> "1" Transaction
TransactionsService --> "1" BlockchainComGateway
TransactionsService --> "1" WalletsService
TransactionsService --> "1" Wallet
TransactionsService --> "*" Transaction
AbstractNotificationStrategy --> "1" Notification
EmailNotificationStrategy --> "1" Notification
NotificationStrategyFactory --> "1" EmailNotificationStrategy
NotificationStrategyFactory --> "1" NotificationStrategy
NotificationStrategyFactory --> "1" AbstractNotificationStrategy
TransactionNotificationService --> "1" Wallet
TransactionNotificationService --> "1" NotificationStrategyFactory
TransactionNotificationService --> "1" Transaction
TransactionNotificationService --> "1" CurrencyType
TransactionWatcherService --> "1" Wallet
TransactionWatcherService --> "1" Transaction
TransactionWatcherService --> "1" BlockchainComGateway
TransactionWatcherService --> "1" TransactionNotificationService
WSTransaction --> "*" Input
WSTransaction --> "*" Out
WalletsService --> "1" Wallet
WalletsService --> "1" TransactionsService
WalletsService --> "1" BlockchainComGateway
WalletsService --> "1" TransactionWatcherService
WalletsService --> "1" CreateWalletRequest
WalletsService --> "1" WalletWithBalance
WalletsService --> "*" WalletWithBalance
WalletsService --> "1" DeleteWalletRequest
WalletsService --> "1" UpdateWalletRequest
WalletsController --> "1" WalletsService
WalletsController --> "1" CreateWalletRequest
WalletsController --> "1" WalletWithBalance
WalletsController --> "1" GetWalletsRequest
WalletsController --> "*" WalletWithBalance
WalletsController --> "1" DeleteWalletRequest
WalletsController --> "1" UpdateWalletRequest
@enduml